# Troubleshooting 503 Service Unavailable

## üîç Diagn√≥stico del Error 503

El error 503 significa que el proxy (Coolify/Traefik) puede conectar al contenedor, pero el servicio no responde correctamente.

---

## ‚úÖ Soluciones Implementadas

### 1. Health Check Mejorado

**Backend /health endpoint ahora:**
- ‚úÖ Siempre retorna `200 OK` y `"status": "healthy"`
- ‚úÖ No falla si no existen datos (datos son opcionales)
- ‚úÖ Informa si hay datos cargados pero no bloquea el servicio

```json
{
  "status": "healthy",
  "app_running": true,
  "data_loaded": false,
  "message": "Data can be generated by running scripts..."
}
```

### 2. Tiempos de Health Check Aumentados

**Backend Dockerfile:**
```dockerfile
HEALTHCHECK --interval=30s --timeout=10s --start-period=90s --retries=5
```

- `start_period=90s` - Da tiempo para que carguen datos GeoJSON grandes
- `retries=5` - M√°s intentos antes de marcar como unhealthy

### 3. Docker Compose Simplificado

**Eliminado del docker-compose.yml:**
- ‚ùå Health checks redundantes (solo en Dockerfile)
- ‚ùå Condiciones de depends_on complejas
- ‚ùå Container names espec√≠ficos
- ‚ùå Redes personalizadas

**Resultado:** Coolify maneja todo autom√°ticamente

---

## üîß Pasos de Verificaci√≥n en Coolify

### 1. Verificar Logs del Contenedor

```bash
# En Coolify UI:
# Resources > [tu servicio] > Containers > backend > Logs

# O via CLI:
docker logs <backend-container-id>
```

**Buscar:**
```
‚úÖ "Application startup complete"
‚úÖ "Uvicorn running on http://0.0.0.0:8000"
‚ùå Errors con GDAL, GeoPandas, o archivos no encontrados
```

### 2. Verificar que el Puerto 8000 Responde

```bash
# Ejecutar dentro del contenedor backend
docker exec <backend-container-id> curl http://localhost:8000/health

# Deber√≠a retornar:
{"status":"healthy","app_running":true,...}
```

### 3. Verificar Configuraci√≥n de Proxy en Coolify

#### Backend Service
- **Port**: 8000 ‚úÖ
- **Path**: `/` (root)
- **Health Check Path**: `/health`
- **Domain**: `lanzat.api.ignacio.tech`

#### Frontend Service
- **Port**: 3000 ‚úÖ
- **Path**: `/` (root)
- **Domain**: `lanzat.ignacio.tech`

### 4. Verificar Variables de Entorno

```bash
# Dentro del contenedor backend
docker exec <backend-container-id> env | grep ALLOWED

# Debe mostrar:
ALLOWED_ORIGINS=https://lanzat.ignacio.tech
```

```bash
# Dentro del contenedor frontend
docker exec <frontend-container-id> env | grep NEXT_PUBLIC

# Debe mostrar:
NEXT_PUBLIC_API_URL=https://lanzat.api.ignacio.tech
```

---

## üêõ Errores Comunes y Soluciones

### Error 1: Backend inicia pero retorna 503

**Causa:** Coolify no detecta correctamente el puerto

**Soluci√≥n:**
1. En Coolify UI, verificar configuraci√≥n del servicio backend
2. Asegurar que "Port" est√° configurado a `8000`
3. Verificar que "Expose" incluye puerto 8000 (docker-compose.yml)

### Error 2: Health Check Falla Inmediatamente

**Causa:** Start period muy corto, backend tarda en cargar datos

**Soluci√≥n:** Ya implementado en Dockerfile:
```dockerfile
HEALTHCHECK --start-period=90s --retries=5
```

Si persiste, aumentar a `120s`:
```dockerfile
HEALTHCHECK --start-period=120s --retries=10
```

### Error 3: CORS Errors en el Frontend

**Causa:** `ALLOWED_ORIGINS` no incluye el dominio del frontend

**Soluci√≥n:**
```bash
# En variables de entorno de Coolify para backend:
ALLOWED_ORIGINS=https://lanzat.ignacio.tech,https://lanzat.api.ignacio.tech
```

### Error 4: "Cannot read properties of undefined"

**Causa:** Frontend no puede conectar con backend

**Soluci√≥n:**
1. Verificar que `NEXT_PUBLIC_API_URL` apunta a backend correcto
2. Verificar que backend est√° accesible desde frontend
3. Probar: `curl https://lanzat.api.ignacio.tech/health`

### Error 5: 502 Bad Gateway (no 503)

**Causa:** Contenedor no est√° corriendo

**Soluci√≥n:**
```bash
# Verificar que los contenedores est√°n UP
docker ps | grep lanzat

# Si no est√°n corriendo, ver logs de build
# En Coolify: Deployments > [√∫ltimo deployment] > Build Logs
```

---

## üîÑ Reinicio Completo (Last Resort)

Si nada funciona:

### 1. Limpiar Deployment en Coolify

```bash
# En Coolify UI:
# Resources > [servicio] > Advanced > Force Rebuild
```

### 2. Verificar docker-compose.yml Actualizado

```bash
git pull origin main
```

Debe contener versi√≥n simplificada:
- ‚úÖ Solo `expose`, no `ports`
- ‚úÖ Sin health checks en docker-compose (solo en Dockerfile)
- ‚úÖ Sin depends_on con condiciones

### 3. Redeploy

```bash
# En Coolify UI:
# Resources > [servicio] > Redeploy
```

---

## üìä Verificaci√≥n de √âxito

### Backend Healthy
```bash
curl https://lanzat.api.ignacio.tech/health

# Respuesta esperada:
{
  "status": "healthy",
  "app_running": true,
  "data_loaded": false,  # OK si no hay datos a√∫n
  "enhanced_data_loaded": false
}
```

### Backend API Funcional
```bash
curl https://lanzat.api.ignacio.tech/

# Respuesta esperada:
{
  "message": "Lanzat API",
  "version": "0.1.0",
  ...
}
```

### Frontend Cargando
```bash
curl https://lanzat.ignacio.tech/

# Respuesta esperada:
<!DOCTYPE html>
<html>...Lanzat - Florida Hurricane...</html>
```

---

## üéØ Generar Datos Post-Deployment

Una vez que el servicio est√© healthy (aunque sin datos):

```bash
# Encontrar container ID
BACKEND_ID=$(docker ps | grep backend | awk '{print $1}')

# Generar datos
docker exec $BACKEND_ID python scripts/download_noaa_hurricanes.py
docker exec $BACKEND_ID python scripts/calculate_real_hurricane_risk.py
docker exec $BACKEND_ID python scripts/enrich_with_statista.py
docker exec $BACKEND_ID python scripts/fetch_active_hurricanes.py

# Verificar que ahora hay datos
curl https://lanzat.api.ignacio.tech/health
# Deber√≠a mostrar "data_loaded": true
```

---

## üìû √öltima Opci√≥n: Debugging Profundo

Si el 503 persiste despu√©s de todo:

```bash
# 1. Ver logs en tiempo real
docker logs -f <backend-container-id>

# 2. Ejecutar shell dentro del contenedor
docker exec -it <backend-container-id> bash

# 3. Probar curl desde dentro
curl localhost:8000/health

# 4. Verificar proceso uvicorn
ps aux | grep uvicorn

# 5. Verificar puerto escuchando
netstat -tlnp | grep 8000
```

---

**Si despu√©s de estos pasos sigue el 503, compartir logs completos del contenedor**
